## Code150 (crypto, 150p)

经过L3m0n和大家的努力，现在已经进入到了SYC Security System的入口，L3m0n凭借着高超的渗透技术截获了SYC Security System Server端和Client端的交互流量数据，你能解开谜团进入到系统深处吗？

 
[RSA_02.zip](./RSA_02.zip)

---------------------------------------


### level4
解压文件后发现一个`level5`的压缩包（需要密码打开，里面是flag文件），还有一个pcap文件。用`wireshare`分析pcap文件，发现是SYC Security System Server端和Client端的交互流量数据，有10个报文。格式如下：

```
__        __   _                            _          ______   ______
\ \      / /__| | ___ ___  _ __ ___   ___  | |_ ___   / ___\ \ / / ___|
 \ \ /\ / / _ \ |/ __/ _ \| '_ ` _ \ / _ \ | __/ _ \  \___ \\ V / |
  \ V  V /  __/ | (_| (_) | | | | | |  __/ | || (_) |  ___) || || |___
   \_/\_/ \___|_|\___\___/|_| |_| |_|\___|  \__\___/  |____/ |_| \____|

 ____                       _ _           ____            _
/ ___|  ___  ___ _   _ _ __(_) |_ _   _  / ___| _   _ ___| |_ ___ _ __ ___
\___ \ / _ \/ __| | | | '__| | __| | | | \___ \| | | / __| __/ _ \ '_ ` _ \
 ___) |  __/ (__| |_| | |  | | |_| |_| |  ___) | |_| \__ \ ||  __/ | | | | |
|____/ \___|\___|\__,_|_|  |_|\__|\__, | |____/ \__, |___/\__\___|_| |_| |_|
                                  |___/         |___/
Please send your public key, then We will use your public key to encrypt int(level5.passwd.encode('hex'), 16), finally, we send the ciphertext to you.
20823369114556260762913588844471869725762985812215987993867783630051420241057912385055482788016327978468318067078233844052599750813155644341123314882762057524098732961382833215291266591824632392867716174967906544356144072051132659339140155889569810885013851467056048003672165059640408394953573072431523556848077958005971533618912219793914524077919058591586451716113637770245067687598931071827344740936982776112986104051191922613616045102859044234789636058568396611030966639561922036712001911238552391625658741659644888069244729729297927279384318252191421446283531524990762609975988147922688946591302181753813360518031
 65537
We have got N is 20823369114556260762913588844471869725762985812215987993867783630051420241057912385055482788016327978468318067078233844052599750813155644341123314882762057524098732961382833215291266591824632392867716174967906544356144072051132659339140155889569810885013851467056048003672165059640408394953573072431523556848077958005971533618912219793914524077919058591586451716113637770245067687598931071827344740936982776112986104051191922613616045102859044234789636058568396611030966639561922036712001911238552391625658741659644888069244729729297927279384318252191421446283531524990762609975988147922688946591302181753813360518031
e is 65537
encrypted messages is 0x68d5702b70d18238f9d4a3ac355b2a8934328250efd4efda39a4d750d80818e6fe228ba3af471b27cc529a4b0bef70a2598b80dd251b15952e6a6849d366633ed7bb716ed63c6febd4cd0621b0c4ebfe5235de03d4ee016448de1afbbe61144845b580eed8be8127a8d92b37f9ef670b3cdd5af613c76f58ca1a9f6f03f1bc11addba30b61bb191efe0015e971b8f78375faa257a60b355050f6435d94b49eab07075f40cb20bb8723d02f5998d5538e8dafc80cc58643c91f6c0868a7a7bf3bf6a9b4b6e79e0a80e89d430f0c049e1db4883c50db066a709b89d74038c34764aac286c36907b392bc299ab8288f9d7e372868954a92cdbf634678f7294096c7
```

大概就是encrypted messages为`pow(int(level5.passwd.encode('hex'), 16), e, N)`。   

首先，把所有`N`,`e`,`encrypted messages`都提取出来，由于不知道`pcap`的格式，所以没有程序提取，都是手工提取的。之后判断下所有`N`是否互质。

``` python
# check coprime
item = [N0, N1, N2, N3, N4, N5, N6, N7, N8, N9]
for i in range(len(item)):
    for j in range(len(item)):
        if i == j: continue 
        if item[i] == item[j]:
            print "equal %d - %d" % (i, j)
            continue
        if gmpy.gcd(item[i], item[j]) != 1:
            print "%d - %d" % (i, j)
```            

结果发现都不互质，那么gcd的值其实就是`p`或`q`,随便选取了两个`N`,就可以解出来，如下：

``` python
def decode(NA, CA, NB):
    p = gmpy.gcd(NA, NB)
    q = NA / p 
    assert(p*q == NA)
    # print p 
    # print q 
    phi = (p-1)*(q-1)
    d = gmpy.invert(e, phi)
    m = pow(CA, d, NA)
    assert(pow(m, e, NA) == CA)
    print ("%01024x" % m).decode('hex')

decode(N0, C0, N1)

# below is output:
# sH1R3_PRlME_1N_rsA_iS_4ulnEra5le

```

用`sH1R3_PRlME_1N_rsA_iS_4ulnEra5le`解压后即得到flag。详细代码请看[ans.py](./ans.py)

