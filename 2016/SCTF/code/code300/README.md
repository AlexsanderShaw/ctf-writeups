## Code300 (crypto, 300p)



 
[RSA_03.zip](./RSA_03.zip)

---------------------------------------


### level3
解压文件后发现一个`level4`的压缩包（需要密码打开，里面是下一层的题目），还有一个pcap文件。用`wireshare`分析pcap文件，有11个报文。格式如下：

```
              .-"""-.
             / .===. \
             \/ 6 6 \/
             ( \___/ )
  _______ooo__\_____/___________
 /                              \
| Welcome to SYC Security System |
 \____________________ooo_______/
             |  |  |
             |_ | _|
             |  |  |
             |__|__|
             /-'Y'-\
            (__/ \__)
Please send your public key and your user_id, then We will add your user_id to the int(level4.passwd.encode('hex'), 16), finally, we put all the message above encryption to send to you.
25357901189172733149625332391537064578265003249917817682864120663898336510922113258397441378239342349767317285221295832462413300376704507936359046120943334215078540903962128719706077067557948218308700143138420408053500628616299338204718213283481833513373696170774425619886049408103217179262264003765695390547355624867951379789924247597370496546249898924648274419164899831191925127182066301237673243423539604219274397539786859420866329885285232179983055763704201023213087119895321260046617760702320473069743688778438854899409292527695993045482549594428191729963645157765855337481923730481041849389812984896044723939553 3 1002

We have got N is 25357901189172733149625332391537064578265003249917817682864120663898336510922113258397441378239342349767317285221295832462413300376704507936359046120943334215078540903962128719706077067557948218308700143138420408053500628616299338204718213283481833513373696170774425619886049408103217179262264003765695390547355624867951379789924247597370496546249898924648274419164899831191925127182066301237673243423539604219274397539786859420866329885285232179983055763704201023213087119895321260046617760702320473069743688778438854899409292527695993045482549594428191729963645157765855337481923730481041849389812984896044723939553
e is 3
user_id is 1002

encrypted messages is 0x547995f4e2f4c007e6bb2a6913a3d685974a72b05bec02e8c03ba64278c9347d8aaaff672ad8460a8cf5bffa5d787c5bb724d1cee07e221e028d9b8bc24360208840fbdfd4794733adcac45c38ad0225fde19a6a4c38e4207368f5902c871efdf1bdf4760b1a98ec1417893c8fce8389b6434c0fee73b13c284e8c9fb5c77e420a2b5b1a1c10b2a7a3545e95c1d47835c2718L

```

大概就是encrypted messages为`pow(int(level4.passwd.encode('hex') + user_id, 16), e, N)`。   

首先，把所有`N`,`e`,`encrypted messages`都提取出来。之后判断下所有`N`是否互质。

``` python
# check coprime
item = [N0, N1, N2, N3, N4, N5, N6, N7, N8, N9, N10]
for i in range(len(item)):
    for j in range(len(item)):
        if i == j: continue 
        if item[i] == item[j]:
            print "equal %d - %d" % (i, j)
            continue
        if gmpy.gcd(item[i], item[j]) != 1:
            print "%d - %d" % (i, j)
```            

结果发现都互质，但`N0`和`N9`是一样的。于是google下，发现了[Franklin-Reiter related-message attack](https://en.wikipedia.org/wiki/Coppersmith's_attack#Franklin-Reiter_related-message_attack)，又找了些资料看，最后Sage代码如下：[PS:可以在线执行](https://sagecell.sagemath.org/)

``` python

c1 = 0x547995f4e2f4c007e6bb2a6913a3d685974a72b05bec02e8c03ba64278c9347d8aaaff672ad8460a8cf5bffa5d787c72722fe4fe5a901e2531b3dbcb87e5aa19bbceecbf9f32eacefe81777d9bdca781b1ec8f8b68799b4aa4c6ad120506222c7f0c3e11b37dd0ce08381fabf9c14bc74929bf524645989ae2df77c8608d0512c1cc4150765ab8350843b57a2464f848d8e08
c2 = 0x547995f4e2f4c007e6bb2a6913a3d685974a72b05bec02e8c03ba64278c9347d8aaaff672ad8460a8cf5bffa5d787c5bb724d1cee07e221e028d9b8bc24360208840fbdfd4794733adcac45c38ad0225fde19a6a4c38e4207368f5902c871efdf1bdf4760b1a98ec1417893c8fce8389b6434c0fee73b13c284e8c9fb5c77e420a2b5b1a1c10b2a7a3545e95c1d47835c2718

n = 25357901189172733149625332391537064578265003249917817682864120663898336510922113258397441378239342349767317285221295832462413300376704507936359046120943334215078540903962128719706077067557948218308700143138420408053500628616299338204718213283481833513373696170774425619886049408103217179262264003765695390547355624867951379789924247597370496546249898924648274419164899831191925127182066301237673243423539604219274397539786859420866329885285232179983055763704201023213087119895321260046617760702320473069743688778438854899409292527695993045482549594428191729963645157765855337481923730481041849389812984896044723939553

id1 = 2614
id2 = 1002
r = id1 - id2

R.<X> = Zmod(n)[]
f1 = X^3 - c2
f2 = (X + r)^3 - c1

def my_gcd(a, b): 
    return a.monic() if b == 0 else my_gcd(b, a % b)

m = - my_gcd(f1, f2).coefficients()[0] # coefficient 0 = -m
print m
print ("%01024x" % (m-id2)).decode('hex')

# below is output:
# 2766183304860995133933011694934796975764977986118568878738477226095101006199323420614968945428600639141020780267130934
# F4An8LIn_rElT3r_rELa53d_Me33Age_aTtaCk_e_I2_s7aLL

```

### level4
用`F4An8LIn_rElT3r_rELa53d_Me33Age_aTtaCk_e_I2_s7aLL`解压后进入level4(又是level4!!!)。还是一样，给了个`level6`的压缩包（需要密码打开，里面是flag文件），还有一个pcap文件。用`wireshare`分析pcap文件，有挺多报文的，格式如下：

```
          .--,       .--,
         ( (  \.---./  ) )
          '.__/o   o\__.'
             {=  ^  =}
              >  -  <
 _________.""`-------`"".________
/                                \
\ Welcome to SYC Security System /
/                                \
\________________________________/
           ___)( )(___
          (((__) (__)))

Please send your public key, then We will use your public key to encrypt int(level6.passwd.encode('hex'), 16), finally, we send the ciphertext to you.
21778816622407043254249033744556437773178718344170907687035355752306254181495272254316323076827432323583279284697609943296234700945010885010381052459024155936090811012664924674758219163065019349740707282354505096608107707774970709715259835448587834080152409078047162951805940071358655938727249679105305351838950073539149057650448964397736279148746703675407495243942505041731104580156762842345374978325029947055323567120523592936170640156611551704828034384851988154353272897487218723570180022092379408219114849763765186588476489924721044926152006318666687949095907516827647042434514271847608156543261745856327152256691
 19
We have got N is 21778816622407043254249033744556437773178718344170907687035355752306254181495272254316323076827432323583279284697609943296234700945010885010381052459024155936090811012664924674758219163065019349740707282354505096608107707774970709715259835448587834080152409078047162951805940071358655938727249679105305351838950073539149057650448964397736279148746703675407495243942505041731104580156762842345374978325029947055323567120523592936170640156611551704828034384851988154353272897487218723570180022092379408219114849763765186588476489924721044926152006318666687949095907516827647042434514271847608156543261745856327152256691

e is 19
encrypted messages is 0x36a66571751faf3bbf6ad760adbcd1be123d2ab526d2fbf6697ec38c7d4ee7d709d8ab3f154092410f46ae18ac75aa32ec9393a98385cd8d8df3b5a15eeccb2637b353f6808fd39e11faf2b742eb0597f8e7a977196171b031c076140cb05c771d8df2f81d8b904e8bf579da0e568fa67d0a94a7607a002c456824e7ea71df895f1967b12ac36eade287589fd556c71520d2dfdb1a8663dcae615cc40be1ff82ae42ae617db75bb1dd88235fd698b53921a42fa6390854eb1393d24341582ce83bd690ea12d2697bc929a77b51adb04131baee52050340be9a2be6eaf795b6877bcc22d5d8cce3829485340b641585ba3ad169850e780562467fbfb09f4f5235

```

encrypted messages为`pow(int(level6.passwd.encode('hex'), 16), e, N)`, 和code150中level4是一样的。同样的，把`N`,`e`,`encrypted messages`提取出来，这次报文有点多，只提取了前面13个(好累啊)，先测试下N是否互质。发现都互质，那么应该是[Håstad's broadcast attack](https://en.wikipedia.org/wiki/Coppersmith's_attack#H.C3.A5stad.27s_broadcast_attack)。测试了下，发现确实是，代码如下：

``` python
from attackrsa import *
t = Hastad.Hastad([N0, N1, N2, N3], e, 
                  [C0, C1, C2, C3])
pt = t.decrypt()
# print pt
print ("%01024x" % pt).decode('hex')

# below is output:
# H1sTaDs_B40aDcadt_attaCk_e_are_same_and_smA9l
```

用`H1sTaDs_B40aDcadt_attaCk_e_are_same_and_smA9l`解压后即得到flag。详细代码请看[ans.py](./ans.py)

