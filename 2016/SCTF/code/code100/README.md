## Code100 (crypto, 100p)

藤原暮雨精通RSA加密算法，他在通往宝藏的路上设置了层层加密(level by level)。那晚，在天台山，L3m0n输给了藤原暮雨，他用惯性漂移过弯，他的车很快，L3m0n只看到他有个x86的招牌……

烫了头的L3m0n毕竟是SYC颜值担当的组草，虽然输给了天台山车神藤原暮雨，但是已经暗中掌握了一些线索，现在他提供了level0到level2的公钥和密文，你能解开线索拿到FLAG进入到SYC Security System的入口吗？
 
[RSA_01.zip](./RSA_01.zip)

---------------------------------------

###　level0
解压文件后，发现有一个公钥，一个下一层的压缩包（解压需要密码），还有一个加密了的密码文件。现在需要先解密密码文件，获得下一层的密码。首先用`openssl`查看公钥，获取`N`和`e`:

```
$ openssl rsa -in public.key -pubin -noout -text -modulus

Public-Key: (2048 bit)
Modulus:
    00:94:a0:3e:6e:0e:dc:f2:74:10:52:ef:1e:ea:a8:
    89:d6:f9:8d:01:11:51:db:5e:90:92:48:fd:39:0c:
    70:87:24:d8:98:3c:f3:33:1c:ba:c5:61:c2:ce:2c:
    5a:f1:5e:65:b2:b2:46:91:56:b6:19:d5:d3:b2:a6:
    bb:a3:7d:56:93:99:4d:7e:4c:2f:aa:60:7b:3e:c8:
    fc:90:b2:00:62:4b:53:18:5b:a2:30:10:60:a8:21:
    ab:61:57:d7:e7:cc:67:1b:4d:cd:66:4c:7d:f1:1a:
    2a:1d:5e:50:80:c1:5e:45:12:3a:ba:4a:53:64:d8:
    72:1f:84:4a:ae:5c:55:02:e8:8e:56:4d:38:70:a5:
    16:36:d3:bc:14:3e:2f:ae:2f:31:58:ba:00:ab:ac:
    c0:c5:ba:44:3c:29:70:56:01:6b:57:f5:d7:52:d7:
    31:56:0b:ab:0a:e6:8d:ad:08:22:a9:1f:cb:6e:49:
    cc:01:4c:12:d2:ab:a3:a5:97:e5:10:49:19:7f:69:
    d9:3b:c5:53:53:71:00:18:60:cc:69:1a:06:64:3b:
    86:94:70:a9:da:82:fc:54:6b:06:23:43:2d:b0:20:
    eb:b6:1b:91:35:5e:53:a6:e5:d8:9a:84:bb:30:46:
    b8:9f:63:bc:70:06:2d:59:d8:62:a5:fd:5c:ab:06:
    68:81
Exponent: 65537 (0x10001)
Modulus=94A03E6E0EDCF2741052EF1EEAA889D6F98D011151DB5E909248FD390C708724D8983CF3331CBAC561C2CE2C5AF15E65B2B2469156B619D5D3B2A6BBA37D5693994D7E4C2FAA607B3EC8FC90B200624B53185BA2301060A821AB6157D7E7CC671B4DCD664C7DF11A2A1D5E5080C15E45123ABA4A5364D8721F844AAE5C5502E88E564D3870A51636D3BC143E2FAE2F3158BA00ABACC0C5BA443C297056016B57F5D752D731560BAB0AE68DAD0822A91FCB6E49CC014C12D2ABA3A597E51049197F69D93BC5535371001860CC691A06643B869470A9DA82FC546B0623432DB020EBB61B91355E53A6E5D89A84BB3046B89F63BC70062D59D862A5FD5CAB066881

```

之后用`RSATool`分解`N`，不到10秒就分解出来了，得到`p`和`q`。借助[rsatool.py](https://github.com/ius/rsatool)生成私钥：
```
$ rsatool.py -p 0xE3DA86D196DD -q 0xA6FC47CA0C3F596B9585BFC491B7515EC5F0701AA5196DF0BB79F75777D12A7EF593B3E2D4D22B32570A5FC9509290542F24FD426C5C631D5F58838A5978DB3980A11340DDFBC4E71B689EB5941876DAC7B2D365332790B8889CB671BEE06EE1CE0DE7E782BFC9400FFC3F8E1F69B67170782E94D2237A95153CC85512561F32EABE939468CC875E4068F51548B69F0C4C9B4C0E2CA3A8EE56A975336B21416B397E272DBD0D0F193EAE8D865E496C30E2A91837042F94E685C0E03659BE760E35977AEA5DAF5D892D09485388253716E7195B18FFFFA796908EA839FD4937695B0F5CA091D19E1B90D4156E0E0A102325D98FCFCAC91F3F33F5 -o private.pem 
```

本来打算直接`openssl`解密的，但密码文件貌似还用base64加密了，用`base64`指令先解密后，在用`openssl`解密也不行。之后尝试用代码`pow(enc, d, N)`来解密，但解密后内容也不对（现在猜测是有padding的原因）。后来借助`Crypto`库，解密成功。代码如下:

``` python
def decrypt_RSA(private_key_loc, package):
	from Crypto.PublicKey import RSA 
	from Crypto.Cipher import PKCS1_OAEP 
	key = open(private_key_loc, "r").read() 
	rsakey = RSA.importKey(key) 
	rsakey = PKCS1_OAEP.new(rsakey) 
	decrypted = rsakey.decrypt(package) 
	return decrypted

from base64 import b64decode
enc = open('level1.passwd.enc', 'r').read()
print decrypt_RSA('private.pem', b64decode(enc))

# below is output:
# FaC5ori1ati0n_aTTA3k_p_tOO_sma11

```

### level1
用`FaC5ori1ati0n_aTTA3k_p_tOO_sma11`解压成功，进入`level1`中，发现和`level0`一样，给了三个文件。还是先用`openssl`查看公钥，获得`N`和`e`，之后用`RSATool`分解`N`，但这次分解了一个小时都没跑出来，这时队友`shell-von`说试试`yafu`，果然，`yafu`一下就跑出结果了：

```
>> factor(0xC3265969E1ED74D2E0B49AD56A7C2F2A9EC371FF134B1037C06F561934C5CB1F6DC0
E3573B47C4763E21A3B0111178D4EE4FE8992B15CBCBD773E4F9A62820FDDB8CEA16ED67C248126E
4B01534A67CB22233B342EAF13EF9345162B009FE04BD190C92C279A34C33FD7EE40F5825039AA8C
E9C27BF436E3389D0450DBA9B73F4B2AD68A2A5C872AEB7435986A9CE452CB9378D2DA3983F30CD1
651E669C4056060D58FC41645E06DA83D03B064270DA3853E0543553CEDE794ABFF53BE5537F6C18
1267A9DE377D44655E680A78393DBB0022350EA394E694151A3D39C7500EB164A529A36941406994
B00D1AEA9A122750EE1E3A19B72970B46D1E9D613E7D)

fac: factoring 24635380199162576175626733825654993088774186468424341251485528171
53939283932914641261501336298028349219948229625022944392589918394160128209233284
34766172771561845076859281935196237658557829760473638836652834244735458779697187
10272046261654326391840252190462805782777380937446430987284386172226304759726517
52984356441209198432898097911511115862467385516637922141593521720692098056490041
46710648271671874179324755835095998026482385736032984284451779573928939284923535
38844661418085667022331283805225000341955464473332333141637604132197773189903937
879276873131228814365139541968760521539920817629563995110317306270531197
fac: using pretesting plan: normal
fac: no tune info: using qs/gnfs crossover of 95 digits
div: primes less than 10000
fmt: 1000000 iterations
Total factoring time = 13.6719 seconds


***factors found***

P309 = 1569566188447068203970128911685125610161729262744064093516052048758488941
34762425857160007206769208250966468865321072899370821460169563046304363342283383
73044885588755971466243820660078044307112563439451197610897941730207828977384770
6397371335621757603520669919857006339473738564640521800108990424511408496383
P309 = 1569566188447068203970128911685125610161729262744064093516052048758488941
34762425857160007206769208250966468865321072899370821460169563046304363342283383
73044885588755971466243820660078044307112563439451197610897941730207828977384770
6397371335621757603520669919857006339473738564640521800108990424511408496259

ans = 1

```

有`p`和`q`,用`rsatool.py`生成私钥，再用`openssl`解密：
```
$ openssl rsautl -decrypt -in level2.passwd.enc -inkey private.pem 
fA35ORI11TLoN_Att1Ck_cL0sE_PrI8e_4acTorS
```

### level2
用`fA35ORI11TLoN_Att1Ck_cL0sE_PrI8e_4acTorS`解压成功，进入`level2`中，发现和`level0`一样，给了三个文件。还是先用`openssl`查看公钥，获得`N`和`e`，之后用`RSATool`分解`N`,不成功；再用`yafu`分解，也分解不出来。发现这次的`N`有些小，`e`有点大，那么`d`可能比较小，想起[wiener's attack](https://en.wikipedia.org/wiki/Wiener%27s_attack),借助[attackrsa.py](https://github.com/rk700/attackrsa)试了下，发现可以：

```
$ python attackrsa.py -e 0x01008e81dda0e31928e8ee511108c7505f613105d2e2ff9b8371e429c2dd927065d4096d58c3763107f1d4fccf2db30a6d027c56617cbe7e0b7ed92228669efb3d2f2c20593c21efff31006afba768de4a0a4c1aa709d54898c81fcffbddf79caeae0b15f4b2c7e0bcba314f5e0783ad0e7fb982a4d201fa68296d667ccf57b94b -n 0x1BA0CC245B45CE5B5F56CD5CAA590C28D123D8A6D7FB64737FB7C1F5A858C1E35138B57B2214FF4B242245F33F72C2C0D21C24AD4C5F50994C2399D73E504A2661D9C4B99D53844AB13D9CD12A4D01679F0AC75F9A4EAA87C32169A17D77D80FD602964C7EA5030637659C7365E98D2EA5BB33A4717082DD5247D4FA7A1F0D573 -t wiener
====== Cracked! =======
d is 0x421996b7ba5429bc8a9b374b74398e63f9e68fc5d95dd3d3c17ed23790bb21b3L
p is 0x161868c2cc72325ff48427339a9c097dfc12718a7bcb30f551686a8fe5b678b2b9937f9ae4dd0427dfbf1ab2fff58930a9669f4a4795cbfdddc4df9472c9ef7dd
q is 0x1401a7c1bc07aa25c48a39fc52896806b41795e92a1acf81a09032f3b14159e8c3bdebdb223a39535e9164ee66e3b41d31b14ebb3de93aefc8f5df6e47eb8558f
```

由于`openssl`解密失败，自己用`pow`解密了下：

``` python
n = 0x1BA0CC245B45CE5B5F56CD5CAA590C28D123D8A6D7FB64737FB7C1F5A858C1E35138B57B2214FF4B242245F33F72C2C0D21C24AD4C5F50994C2399D73E504A2661D9C4B99D53844AB13D9CD12A4D01679F0AC75F9A4EAA87C32169A17D77D80FD602964C7EA5030637659C7365E98D2EA5BB33A4717082DD5247D4FA7A1F0D573
d = 29897859398360008828023114464512538800655735360280670512160838259524245332403

enc = open('level3.passwd.enc', 'r').read()
enc = int(enc.encode('hex'), 16)

assert(enc < n)
text = pow(enc, d, n)
print ("%01024x" % text).decode('hex')


# below is output:
j�������Ibq�[��.��i}#
s����'w+���
           t�����5�dC�6���]���F���;��,��e��l�9L�q��ۉ�$$x��BwIe6ER1s_1TtA3k_e_t00_larg3

```

输出前面是乱码，但最后的字符貌似是对的，看了前面两个密码的格式，貌似是解密方法的名字，那这里的密码应该是`wIe6ER1s_1TtA3k_e_t00_larg3`，解压成功，拿到flag。


### 总结
虽然三个关卡都过，但还是有些疑问未能解疑：
+ `RSATool`和`yafu`分解因子的算法具体有那些不同，什么样的场景更适合用那个工具?
+ 为何`level0`自己用pow解密不成功？
+ `level2`解密后前面的乱码是真的乱码还是解密的方式还是有些不对？
